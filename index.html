<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="theme-color" content="#eee">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>iOS Support - Đoàn</title>
<link rel="icon" type="image/png" href="./image/appstore.png">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<style>
    :root {
        --border-radius: 5px;
        --spacing: 5px;
        --primary-color: #9bff9b;
        --border-color: #555;
    }
    
    body {max-width: 800px;margin: 10px auto;}
    
    .rainbow-animated {
        background: linear-gradient(90deg, #ff0000, #ffa600, #00f7ff);
        background-clip: text;
        -webkit-background-clip: text; 
        -webkit-text-fill-color: transparent;
        text-align: center;
    }
    
    .copy-feedback {display: none;color: green;font-weight: bold;}
    .copy-feedback.visible {display: flex;align-items: center;}
    
    .section, label {
        width: calc(100% - 50px);
        margin: auto;
        display: flex;
        gap: 10px;
    }
    
    button {
        flex: 1;
        border-radius: var(--border-radius);
        border: 1px solid var(--border-color);
        padding: 6px 12px;
        margin: var(--spacing) auto;
        font-weight: bold;
        cursor: pointer;
    }
    
    button:hover {background-color: var(--primary-color);}
    
    input {
        flex: 3;
        border: 1px dashed var(--border-color);
        border-radius: var(--border-radius);
        margin: var(--spacing) auto;
        padding: var(--spacing);
    }
    
    h1, h2, h3, h4, h5, h6 {white-space: nowrap;margin: 0 auto;padding: 0 15px;}
    #btn-contact {display: none; color: red;flex: 3;}
    #btnCheckKey {flex: 2;}
</style>
</head>
<body>
<main>
    <h2 class="rainbow-animated">Apple ID - Phạm Bình Đoàn</h2>
    <div class="account">
        <label><button id="btnGenUser">Tạo Apple ID New</button></label>
        <label><button id="btn-contact" style="display: block;">Liên Hệ Lấy Key</button></label>
        <label><button>Full Name</button><input type="text" id="fullName" readonly></label>
        <label><button>Apple ID</button><input type="text" id="appleId" readonly></label>
        <label><button>Địa chỉ</button><input type="text" id="address" readonly></label>
        <div id="UpdateKey">
            <label><input type="text" id="inputKey" placeholder="Liên Hệ Đoàn Cho Key!"></label>
            <label><button id="btnCheckKey">Load Account</button><button id="btn-contact"></button></label>
        </div>
      </div>
    </div>
    <div id="dataContainer"></div>
  </main>
<script>
const state = {
  baseUrl: "https://script.google.com/macros/s/AKfycbwUQZaUuZqmeMeSDrGU_HSd0JLsL2Hxn0i6O_59SQuSKQCjY9-FeOg15aGXTmicNm6_/exec",
  headers: [],  sheetData: [],  liveData: [],  currentRowIndex: 0,  currentUser: null,  userKey: ""
};

const $ = id => document.getElementById(id);

function setInputValues(obj) {
  ['fullName','appleId','address'].forEach(id => $(id).value = obj[id] || "");
}

async function generateRandomUser() {
  try {
    const res = await fetch('https://randomuser.me/api/?nat=ca');
    if (!res.ok) throw new Error("Không thể lấy dữ liệu user ngẫu nhiên!");
    const user = (await res.json()).results[0];
    state.currentUser = {
      fullName: `${user.name.first} ${user.name.last}`,
      appleId: `${user.name.first}${user.name.last}.${user.location.street.number}@icloud.com`.toLowerCase(),
      address: `${user.location.street.number} ${user.location.street.name} ${user.location.city} ${user.location.state} ${user.location.postcode} ${user.location.country}`
    };
    setInputValues(state.currentUser);
  } catch (e) {
    setInputValues({});
    alert('Lỗi tạo user: ' + e.message);
  }
}

async function checkKeyAndLoad() {
    const keyInput = $('inputKey');
    const btnContact = $('btn-contact');
    const btnCheckKey = $('btnCheckKey');
    state.userKey = keyInput.value.trim();
    if (!state.userKey) {
        btnContact.style.display = 'block';
        btnContact.textContent = 'Liên Hệ Đoàn Lấy Key!';
        btnContact.onclick = () => window.open('https://t.me/+KyqhU98-VAAwZDM1', '_blank');
        keyInput.focus();
        return;
    }
    btnContact.style.display = 'none';
    btnCheckKey.innerHTML = '<span class="fas fa-spinner fa-spin"></span>';
    btnCheckKey.disabled = true;
    await loadData();
    // Hide the button after successful load
    btnCheckKey.style.display = 'none';
}

async function loadData() {
  try {
    const url = `${state.baseUrl}?&key=${encodeURIComponent(state.userKey)}`;
    const res = await fetch(url);
    const json = await res.json();
    if (!res.ok) {
      alert(json.error || 'Lỗi không xác định từ server!');
      return;
    }
    state.headers = json.headers || [];
    state.sheetData = json.data || [];
    state.sheetData.forEach(row => row.forEach((v,i) => {
      if (typeof v === 'string' && v.includes("T") && v.includes("Z")) row[i] = formatDate(v);
    }));
    state.liveData = state.sheetData.filter(row => row && row[3] && row[3].toString().trim().toLowerCase() === "live");
    if (state.liveData.length) {
      state.currentRowIndex = 0;
      $('UpdateKey').style.display = 'none';
      displayData(state.currentRowIndex);
    } else {
    $("dataContainer").innerHTML = `
    <label><button>Nhập Sai Key Rồi!</button><button onclick="window.open('https://t.me/+KyqhU98-VAAwZDM1', '_blank')">Liên Hệ Lấy Key</button></label>
    <label><button id="btnWrongKey">Reload Lại Trang!</button></label>
    `;
      $("btnWrongKey").onclick = () => location.reload();
    }
  } catch (e) {
    alert('Có lỗi xảy ra khi tải dữ liệu!');
  }
}

async function sendToSheet() {
  const sendBtn = $('sendBtn');
  sendBtn.disabled = true;
  sendBtn.textContent = "Đang gửi...";
  try {
    await fetch(state.baseUrl, {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: new URLSearchParams({
        key: state.userKey,
        colB: state.currentUser.fullName,
        colC: state.currentUser.appleId,
        colH: state.currentUser.address || "",
      }),
    });
    sendBtn.textContent = "Gửi Xong!";
    setTimeout(() => { sendBtn.style.display = 'none'; }, 1000);
  } catch (e) {}
}

function formatDate(iso) {
  if (!iso) return "";
  return new Date(iso).toLocaleString('vi-VN', {
    year: 'numeric', month: '2-digit', day: '2-digit',
    hour: '2-digit', minute: '2-digit', second: '2-digit',
    timeZone: 'Asia/Ho_Chi_Minh'
  });
}

function displayData(rowIndex) {
  state.currentRowIndex = rowIndex;
  const row = state.liveData[rowIndex];
  const originalRowIndex = state.sheetData.findIndex(r => r === row);
  $("dataContainer").innerHTML = `
    <label><button id="sendBtn">Gửi</button></label>
    <label><button id="reloadBtn">Reload</button></label>
    <div class="section">
      <button id="prevBtn" ${rowIndex <= 0 ? "disabled" : ""}>Prev</button>
      <button>Hàng ${originalRowIndex + 2}</button>
      <button id="nextBtn" ${rowIndex >= state.liveData.length - 1 ? "disabled" : ""}>Next</button>
    </div>
        ${state.headers.map((header, i) => {
      if ([0,3,6].includes(i)) return '';
      const value = row[i] || "";
      const isEmpty = String(value).trim() === "";
      return `<div id="${header}">
        <h4>${header}</h4>
        <div class="section">
          <input class="copytext" value="${isEmpty ? 'Chưa có dữ liệu!' : value}" id="accountData-${rowIndex}-${i}" readonly />
          ${!isEmpty ? `
            <button class="btn-copy fas fa-copy" data-copy-id="accountData-${rowIndex}-${i}" data-copy-value="${value}" type="button"></button>
            <span id="feedback-accountData-${rowIndex}-${i}" class="copy-feedback">Đã copy!</span>
          ` : ''}
        </div>
      </div>`;
    }).join('')}
  `;
  $('sendBtn')?.addEventListener('click', sendToSheet);
  $('reloadBtn')?.addEventListener('click', async function () {
    const reloadBtn = this;
    const oldHtml = reloadBtn.innerHTML;
    reloadBtn.innerHTML = '<span class="fas fa-spinner fa-spin"></span>';
    reloadBtn.disabled = true;
    await loadData();
    reloadBtn.innerHTML = 'Reload';
    reloadBtn.disabled = false;
  });
}

$("dataContainer").addEventListener("click", async (e) => {
  const btn = e.target.closest(".btn-copy");
  if (btn) {
    if (!navigator.clipboard) return alert("Trình duyệt không hỗ trợ copy tự động.");
    const value = btn.getAttribute("data-copy-value") || "";
    const copyId = btn.getAttribute("data-copy-id");
    try {
      await navigator.clipboard.writeText(value);
      const feedback = $(`feedback-${copyId}`);
      if (feedback) {
        btn.style.display = "none";
        feedback.classList.add("visible");
        setTimeout(() => {
          feedback.classList.remove("visible");
          btn.style.display = "inline-block";
        }, 2000);
      }
    } catch {}
  }
  if (e.target.id === "prevBtn" && state.currentRowIndex > 0) displayData(state.currentRowIndex - 1);
  if (e.target.id === "nextBtn" && state.currentRowIndex < state.liveData.length - 1) displayData(state.currentRowIndex + 1);
});

window.addEventListener("DOMContentLoaded", () => {
  generateRandomUser();
  $('btnGenUser').onclick = generateRandomUser;
  $('btnCheckKey').onclick = checkKeyAndLoad;
});
</script>
</body>
</html>
